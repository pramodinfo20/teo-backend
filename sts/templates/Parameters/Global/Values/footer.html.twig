{% trans_default_domain 'messages' %}

<div id="global_values_sets_actions" class="horizontalMenuButtons">
    <div class="MiniButtons">
        <ul class="submenu_ul">
            <li><span class="sts_submenu W130 {{ (parametersButtonsState.isEditAvailable) ? '' : 'disabled' }}"
                      id="btn_edit_set">{{ 'parameters.values.twig.footer.edit' | trans }}</span></li>
            <li><span class="sts_submenu W130 {{ (parametersButtonsState.isSaveAvailable) ? '' : 'disabled' }}"
                      id="btn_save_set">{{ 'parameters.values.twig.footer.save' | trans }}</span></li>
            <li><span class="sts_submenu W130 {{ (parametersButtonsState.isCancelAvailable) ? '' : 'disabled' }}"
                      id="btn_cancel_set">{{ 'parameters.values.twig.footer.cancel' | trans }}</span></li>
            <li><span class="sts_submenu W130 {{ (parametersButtonsState.isCopyAvailable) ? '' : 'disabled' }}"
                      id="btn_copy_set">{{ 'parameters.values.twig.footer.copy' | trans }}</span></li>
        </ul>
    </div>
</div>

{# ---------------------------- Dialogs ----------------------------------------- #}
<div id="copy-values-dialog" title="{{ 'parameters.values.twig.footer.dialog.title.copyValue' | trans }}">
    <p>{{ 'parameters.values.twig.footer.dialog.body.selectSub' | trans }}</p>
    <p>
    <form action='' method='post' id="copy-values"></form>
    </p>
    <p style="font-weight: bold">{{ 'parameters.values.twig.footer.dialog.body.info' | trans }}</p>
    <p>{{ 'parameters.values.twig.footer.dialog.body.selectUnderDevelopment' | trans }}</p>
</div>

<div id="value-validation-dialog" title="{{ 'parameters.values.twig.footer.dialog.title.incorrectValue' | trans }}">
    <p>{{ 'parameters.values.twig.footer.dialog.body.valueBetween' | trans }}</p>
</div>

{% include '/Parameters/Global/saveDataValidationError.html.twig' %}
{# ------------------------------------------------------------------------------ #}

{% block stylesheets %}
    <style>
        #treeview > ul, li {
            list-style-type: none;
        }
    </style>
{% endblock %}

{% block javascripts %}
    <script>
        $(document).ready(function () {
            $(document).on('click', '#btn_edit_set', function () {
                if ($('#btn_edit_set').hasClass('disabled')) {
                    return false;
                }
                window.location.href = 'index.php?action=globalValuesSets&method=regenerateView&' +
                    'type=' + '{{ search['type'] }}' + '&year=' + {{ search['year'] }} +'&series=' + '{{ search['series'] }}' +
                    '&configuration=' + {{ search['configuration'] }} +'&global=' + {{ search['global'] }} +'&mode=2';
            });

            $(document).on('click', '#btn_save_set', function () {
                if ($('#btn_save_set').hasClass('disabled')) {
                    return false;
                }

                $.ajax({
                    method: 'POST',
                    data: $('#saveGPValueSet').serialize(),
                    url: 'index.php?action=globalValuesSets&method=ajaxCallPost&globals=configuration&ajax=' + {{ search['configuration'] }} +
                        '&global=' + {{ search['global'] }} +'&path=save',
                    dataType: "json",
                    success: function (result) {

                        if (result['status'] === 'success') {
                            window.location.href = 'index.php?action=globalValuesSets&method=regenerateView&' +
                                'type=' + '{{ search['type'] }}' + '&year=' + {{ search['year'] }} +'&series=' + '{{ search['series'] }}' +
                                '&configuration=' + {{ search['configuration'] }} +'&global=' + {{ search['global'] }} +'&mode=1';
                        } else {
                            saveValidationErrorWindow(result);
                        }
                    }
                })
            });

            $(document).on('click', '#btn_cancel_set', function () {
                if ($('#btn_cancel_set').hasClass('disabled')) {
                    return false;
                }
                window.location.href = 'index.php?action=globalValuesSets&method=regenerateView&' +
                    'type=' + '{{ search['type'] }}' + '&year=' + {{ search['year'] }} +'&series=' + '{{ search['series'] }}' +
                    '&configuration=' + {{ search['configuration'] }} +'&global=' + {{ search['global'] }} +'&mode=1';
            });

            $(document).on('click', '#btn_copy_set', function () {
                if ($('#btn_copy_set').hasClass('disabled')) {
                    return false;
                }

                $.ajax({
                    method: 'GET',
                    data: {
                        action: 'globalValuesSets',
                        method: 'ajaxCall',
                        path: 'configurations',
                        ajax: 'get'
                    },
                    url: 'index.php',
                    dataType: "json",

                    success: function (result) {
                        let txt = '<ul id="treeview">';

                        $.each(result, function (indexType, valueUType) {
                            txt += '<li> <i class="fas fa-plus"></i>';
                            txt += '<label> ' +
                                '<input id="' + indexType + '" data-id="' + indexType + '" type="checkbox" />'
                                + indexType + '</label>';
                            txt += '<ul>';
                            $.each(valueUType, function (indexYear, valueUYear) {
                                txt += '<li> <i class="fas fa-plus"></i>';
                                txt += '<label> ' +
                                    '<input id="' + indexType + '_' + indexYear + '" data-id="' + indexYear + '" ' +
                                    'type="checkbox" />' + indexYear + '</label>';
                                txt += '<ul>';
                                $.each(valueUYear, function (indexSeries, valueUSeries) {
                                    txt += '<li> <i class="fas fa-plus"></i>';
                                    txt += '<label> <input id="' + indexType + '_' + indexYear + '_' + indexSeries + '"' +
                                        ' data-id="' + indexSeries + '" type="checkbox" />' + indexSeries + '</label>';
                                    txt += '<ul>';
                                    $.each(valueUSeries, function (indexConfiguration, valueUConfiguration) {
                                        txt += '<li> <i class="fas fa-plus"></i>';
                                        txt += '<label> <input id="' + indexType + '_' + indexYear + '_' + indexSeries + '_'
                                            + indexConfiguration + '" ' +
                                            'data-id="' + indexConfiguration + '" type="checkbox" />' +
                                            valueUConfiguration[Object.keys(valueUConfiguration)[0]]['configuration'] +
                                            '</label>';
                                        txt += '<ul>';
                                        $.each(valueUConfiguration, function (indexSubConfiguration, valueUSubConfiguration) {
                                            txt += '<li>';
                                            txt += '<label> <input id="' + indexType + '_' + indexYear + '_' + indexSeries + '_'
                                                + indexConfiguration + '_' + indexSubConfiguration + '" ' +
                                                'data-id="' + indexConfiguration + '" type="checkbox" class="hummingbirdNoParent" ' +
                                                'name="subconfiguration[]" value="' + indexSubConfiguration + '"/>' +
                                                valueUSubConfiguration['subconfiguration'] +
                                                '</label>';
                                            txt += '</li>';
                                        });
                                        txt += '</ul>';
                                        txt += '</li>';
                                    });
                                    txt += '</ul>';
                                    txt += '</li>';
                                });
                                txt += '</ul>';
                                txt += '</li>';
                            });
                            txt += '</ul>';
                            txt += '</li>';
                        });
                        txt += '</ul>';
                        txt += '<input type="hidden" name="sourceConfiguration" value="' + {{ search['configuration'] }} +'">';
                        txt += '<input type="hidden" name="global" value="' + {{ search['global'] }} +'">';
                        $('#copy-values').empty().append(txt);

                        $("#treeview").hummingbird();
                        $("#treeview").hummingbird("collapseAll");

                        copyValuesDialog.dialog("open");
                    }
                })
            });

            let copyValuesDialog = $("#copy-values-dialog").dialog({
                autoOpen: false,
                resizable: false,
                height: "auto",
                width: 600,
                modal: true,
                buttons: {
                    "{{ 'dialog.button.copyValue' | trans }}": function () {
                        let arrayOfConfigurations = [];
                        $('#copy-values').find("input[name='subconfiguration[]']:checked").each(function () {
                            arrayOfConfigurations.push(parseInt($(this).val()));
                        });

                        saveCopiedValues(arrayOfConfigurations);
                    },
                    "{{ 'dialog.button.cancel' | trans }}": function () {
                        copyValuesDialog.dialog("close");
                    }
                }
            });

            let valueValidationDialog = $("#value-validation-dialog").dialog({
                autoOpen: false,
                resizable: false,
                height: "auto",
                width: 600,
                modal: true,
                buttons: {
                    "{{ 'dialog.button.ok' | trans }}": function () {
                        valueValidationDialog.dialog("close");
                    }
                }
            });

            function saveCopiedValues(objectToSend) {
                $.ajax({
                    method: 'POST',
                    data: {
                        jsonWithSubConfigurations: JSON.stringify(objectToSend)
                    },
                    url: 'index.php?action=globalValuesSets&method=ajaxCallPost&path=globals&configuration=' +
                            {{ search['configuration'] }} +'&global=' + {{ search['global'] }} +'&ajax=copy',
                    dataType: "json",
                    success: function (result) {
                        copyValuesDialog.dialog("close");
                    }

                });
            }
        });
    </script>
{% endblock %}